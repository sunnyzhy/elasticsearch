# 分片重要性
ES 中所有的数据均衡地存储在集群中各个节点的分片中，直接影响 ES 的性能、安全和稳定性。

# 分片概述
分片是 ES 中所有数据的文件块，也是数据的最小单元块，整个 ES 集群的核心就是对所有分片的分布、索引、负载、路由等。

```
实列场景：

假设 IndexA 有 2 个分片，向 IndexA 中插入 10 条数据 (10 个文档)，那么这 10 条数据会尽可能平均的分为 5 条存储在第一个分片，剩下的 5 条会存储在另一个分片中。
```

# 分片设置
创建 IndexName 索引时候，在 Mapping 中可以如下设置分片
```json
PUT indexName
{
    "settings": {
        "number_of_shards": 5
    }
}
```

```
注意

索引建立后，分片个数是不可以更改的
```

# 分片个数（数据节点计算）
分片个数是越多越好，还是越少越好了？根据整个索引的数据量来判断。

```
实列场景：

如果 IndexA 所有数据文件大小是300G，改怎么定制方案？(可以通过Head插件来查看)

建议：（仅参考）

   1、每一个分片数据文件小于30GB

   2、每一个索引中的一个分片对应一个节点

   3、节点数大于等于分片数
```

根据建议，至少需要 10 个分片。

结果： 建 10 个节点 (Node)，Mapping 指定分片数为 10，满足每一个节点一个分片，每一个分片数据带下在30G左右。

**SN(分片数) = IS(索引大小) / 30**

**NN(节点数) = SN(分片数) + MNN(主节点数[无数据]) + NNN(负载节点数)**

# 分片查询
- **randomizeacross shards**

随机选择分片查询数据，es的默认方式

- **_local**

优先在本地节点上的分片查询数据然后再去其他节点上的分片查询，本地节点没有IO问题但有可能造成负载不均问题。数据量是完整的。

- **_primary**

只在主分片中查询不去副本查，一般数据完整。

- **_primary_first**

优先在主分片中查，如果主分片挂了则去副本查，一般数据完整。

- **_only_node**

只在指定id的节点中的分片中查询，数据可能不完整。

- **_prefer_node**

优先在指定你给节点中查询，一般数据完整。

- **_shards**

在指定分片中查询，数据可能不完整。

- **_only_nodes**

可以自定义去指定的多个节点查询，es不提供此方式需要改源码。
